<html>
<head>
	<title>ortiz home temp monitor</title>
	<!-- inject:css -->
	<link rel="stylesheet" href="css/vendor.css">
	<!-- endinject -->
</head>
<body ng-app="tempMon">
	<div class="container">
		<h1>Aktuell</h1>
		<div ng-controller="NewestMeasurementController">
			<table class="table">
				<thead>
					<tr><th>Temperatur Wohnzimmer</th><th>Temperatur Wohnzimmer (gef&uuml;hlt)</th><th>Feuchtigkeit Wohnzimmer</th></tr>
				</thead>
				<tbody>
					<tr><td>{{ tempInside }}</td><td>{{ tempRelInside }}</td><td>{{  moistnessInside }}</td></tr>
				</tbody>
			</table>
			<table class="table">
				<thead>
					<tr><th>Temperatur Aussen</th><th>Feuchtigkeit Aussen</th></tr>
				</thead>
				<tbody>
					<tr><td>{{ tempOutside }}</td><td>{{ moistnessOutside }}</td></tr>
				</tbody>
			</table>
	    </div>
		<h1>Letzte Stunde</h1>	
		<div ng-controller="ChartController">
			<canvas id="line" class="chart chart-line" chart-data="data"
			  chart-labels="labels" chart-legend="true" chart-series="series"
			  chart-click="onClick" >
		</canvas> 
		</div>
	</div>
	
	<!-- inject:js -->
	<script src="js/vendor.js"></script>
	<!-- endinject -->
	<script type="text/javascript">
		var tempMon = angular.module('tempMon', ['chart.js']);

		tempMon.controller('ChartController', ['$scope', 'TemperatureService', 
			function ($scope, TemperatureService) {

				TemperatureService.getMessungen().then(function (messungen) {
					$scope.labels = messungen.labels;
					$scope.data = messungen.data;
					$scope.series = messungen.series;
				});

				$scope.onClick = function (points, evt) {
					console.log(points, evt);
				};
		}]);

		tempMon.controller('NewestMeasurementController', ['$scope', 'TemperatureService',
			function ($scope, TemperatureService) {
				TemperatureService.getNewestMessung().then(function (messung) {
					$scope.tempInside = messung.temperatur;
					$scope.tempRelInside = messung.temperatur_gefuehlt;
					$scope.moistnessInside = messung.feuchtigkeit;

					$scope.tempOutside = messung.temperatur_aussen;
					$scope.moistnessOutside = messung.feuchtigkeit_aussen;
				});
			}]);

		tempMon.service('TemperatureService', ['$http', '$q', function ($http, $q) {
			var service = {};

			service.url = 'http://home-ortiz.rhcloud.com/api/';
			service.getMessungen = function () 
			{
				return $http({ method: 'GET', url: this.url + 'messungen' }).then(function (response) {
			    	// map data
			    	var messungen = {};
			    	messungen.labels = [];
			    	messungen.series = ['Wohnzimmer', 'Gefuehlt', 'Aussen'];
			    	messungen.data = [[], [], []];
					angular.forEach(response.data, function(value, key){
						var zeit = new Date(value.zeit);
						messungen.labels.push(zeit.getHours() + ":" + (zeit.getMinutes() < 10 ? "0" : "" ) + zeit.getMinutes());
						messungen.data[0].push(value.temperatur);
						messungen.data[1].push(value.temperatur_gefuehlt);
						messungen.data[2].push(value.temperatur_aussen);
					});

			    	return messungen;
			  	});
			}
			service.getNewestMessung = function () 
			{
				return $http({ method: 'GET', url: this.url + 'messungen/current' }).then(function (response) {
			    	return response.data;
			  	});
			}
			return service;
		}]);
	</script>
</body>
</html>